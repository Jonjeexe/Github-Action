name: Generate Device Tree (X6815D)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-tree:
    runs-on: ubuntu-latest
    env:
      FIRMWARE_ID: "1-65PV4enM35j72dhMa4STSMwLNdqR-NV"
      TG_CHAT_ID: "1910625218"
      TG_BOT_TOKEN: "7863915048:AAG0PjWioCIeIlP9kDdvsTDkKfJ2J57dR-Q"

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update -y
        sudo apt-get install -y git python3 python3-pip unzip curl p7zip-full
        pip3 install dumpyara aospdtgen gdown

    - name: Download firmware
      run: |
        mkdir -p firmware
        gdown "$FIRMWARE_ID" -O firmware/fw.zip
        ls -lh firmware/

    - name: Extract firmware (multiple methods)
      run: |
        cd firmware
        # Try dumpyara
        echo "::group::Trying dumpyara"
        python3 -m dumpyara fw.zip || echo "::warning:: dumpyara failed"
        ls -lh .
        echo "::endgroup::"
        # Fallback to 7z
        echo "::group::Trying 7z fallback"
        7z x fw.zip -oextracted || echo "::warning:: 7z extraction failed"
        ls -lh extracted/
        echo "::endgroup::"
        # Fallback to unzip
        echo "::group::Trying unzip fallback"
        unzip fw.zip -d extracted2 || echo "::warning:: unzip failed"
        ls -lh extracted2/
        echo "::endgroup::"

    - name: Pick dump directory
      id: dump
      run: |
        if [ -d "firmware/extracted" ] && [ -n "$(ls firmware/extracted)" ]; then
          DUMP="firmware/extracted"
        elif [ -d "firmware/extracted2" ] && [ -n "$(ls firmware/extracted2)" ]; then
          DUMP="firmware/extracted2"
        else
          DUMP=$(find firmware -type f \( -iname "boot*.img" -o -iname "vendor*.img" \) -printf '%h\n' | head -n1 || true)
        fi
        echo "::debug:: Using dump directory: $DUMP"
        echo "dump_dir=$DUMP" >> $GITHUB_OUTPUT

    - name: Check dump contents
      run: |
        DUMP="${{ steps.dump.outputs.dump_dir }}"
        echo "::group::Dump folder listing"
        ls -lh "$DUMP" || echo "::warning:: Dump directory not found"
        echo "::endgroup::"
        if ! ls "$DUMP"/*.{img,IMG} 1> /dev/null 2>&1; then
          echo "::error:: No .img files found, aborting"
          exit 1
        fi

    - name: Generate device tree
      run: |
        DUMP="${{ steps.dump.outputs.dump_dir }}"
        mkdir -p device/infinix/X6815D
        python3 -m aospdtgen -o device/infinix/X6815D "$DUMP" || echo "::warning:: aospdtgen may have failed"
        ls -lh device/infinix/X6815D/

    - name: Extract kernel from boot.img
      run: |
        DUMP="${{ steps.dump.outputs.dump_dir }}"
        BOOTIMG=$(find "$DUMP" -type f -iname "boot*.img" | head -n1 || true)
        mkdir -p device/infinix/X6815D/prebuilt
        if [ -n "$BOOTIMG" ]; then
          echo "Found boot image: $BOOTIMG"
          curl -L -o magisk.zip https://github.com/topjohnwu/Magisk/releases/latest/download/Magisk-v28.1.zip || true
          unzip -j magisk.zip "*/magiskboot" -d .
          chmod +x magiskboot || true
          ./magiskboot unpack "$BOOTIMG" || echo "::warning:: magiskboot unpack failed"
          mv -f kernel* dtb* dtbo.img* ramdisk.cpio* device/infinix/X6815D/prebuilt/ 2>/dev/null || true
        else
          echo "::warning:: No boot.img found"
        fi
        ls -lh device/infinix/X6815D/prebuilt/

    - name: Zip device tree
      run: |
        if [ -n "$(find device/infinix/X6815D -type f -maxdepth 2)" ]; then
          zip -r device-tree-X6815D.zip device/infinix/X6815D
        else
          echo "::warning:: Device tree is empty"
          echo "NO_TREE=true" >> $GITHUB_ENV
        fi

    - name: Upload device tree zip
      if: env.NO_TREE != 'true'
      uses: actions/upload-artifact@v4
      with:
        name: device-tree-X6815D
        path: device-tree-X6815D.zip

    - name: Save logs
      if: failure()
      run: |
        mkdir -p logs
        dmesg > logs/dmesg.txt || true
        journalctl -xe > logs/journal.txt || true

    - name: Upload logs (on failure)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: logs

    - name: Telegram notification
      if: always()
      run: |
        RUN_URL="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
        if [ "${{ job.status }}" == "success" ] && [ -f "device-tree-X6815D.zip" ]; then
          curl -s -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendDocument" \
            -F chat_id="${TG_CHAT_ID}" \
            -F document=@device-tree-X6815D.zip \
            -F caption="✅ Device tree generated: Run $RUN_URL"
        else
          curl -s -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TG_CHAT_ID}" \
            -d text="❌ Generation failed or empty. Logs: $RUN_URL"
